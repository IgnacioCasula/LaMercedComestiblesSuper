<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Comestibles la Merced - Registrar Venta</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
{% load static %}
<link href="{% static 'CSS/ventas.css' %}" rel="stylesheet">
</head>
<body>

<!-- ===== FACTURACI√ìN ===== -->
<div id="ventas" class="container py-4">
  <div class="frame">
    <div class="d-flex align-items-center gap-2 mb-2">
      <span class="pill">üßæ Facturaci√≥n - Comestibles la Merced</span>
      <span class="pill">Cajero: {{ usuario_nombre }}</span>
      <span class="pill">Sucursal: {{ sucursal.nombresucursal }}</span>
      <span class="pill">Caja: {{ caja_activa.nombrecaja }}</span>
    </div>

    <div class="workarea">
      <!-- tabla -->
      <div class="gridwrap">
        <div class="gridhead">
          <span class="pill w-100 text-center">Cantidad</span>
          <span class="pill w-100 text-center">Producto</span>
          <span class="pill w-100 text-center">Precio</span>
          <span class="pill w-100 text-center">Total</span>
        </div>

        <table class="sheet" id="tabla">
          <thead>
            <tr>
              <th style="width:120px">Cantidad</th>
              <th>Producto</th>
              <th style="width:140px">Precio</th>
              <th style="width:140px">Total</th>
            </tr>
          </thead>
          <tbody id="tablaBody"></tbody>
        </table>
      </div>

      <!-- lateral -->
      <aside class="side">
        <!-- CAMPO DE CARGA DE PRODUCTO -->
        <div class="label"><span class="pill">Carga de Producto</span></div>
        <div class="d-flex gap-2">
          <input id="productoInput" class="inpt" placeholder="Nombre del Producto"
                 list="productosLista">
          <datalist id="productosLista"></datalist>
          <button class="btn-purple px-3" id="btnAgregarProducto">+</button>
        </div>

        <div class="label mt-3"><span class="pill">M√©todo de Pago</span></div>
        <select id="metodoPago" class="inpt">
          <option value="EFECTIVO">EFECTIVO</option>
          <option value="TARJETA DEBITO">TARJETA D√âBITO</option>
          <option value="TARJETA CREDITO">TARJETA CR√âDITO</option>
          <option value="TRANSFERENCIA">TRANSFERENCIA</option>
        </select>
       
        <div class="label mt-3"><span class="pill">Fecha</span></div>
        <input type="date" class="inpt" id="fechaVenta" value="{{ today|date:'Y-m-d' }}">

        <div class="label mt-3"><span class="pill">Resumen</span></div>
        <div class="totbox mt-2">
          <div>Subtotal</div><input id="subtotal" class="inpt" readonly value="$0">
          <div>Recargo</div><input id="recargo" class="inpt" value="0">
          <div>Total</div><input id="total" class="inpt" readonly value="$0">
        </div>

        <div class="actions mt-3">
          <button class="btn-green" id="btnEmitirTicket">Emitir Ticket</button>
          <button class="btn-orange" id="btnActivarEliminar">Eliminar</button>
          <button class="btn-red" id="btnCancelarTodo">Limpiar Lista de Productos</button>
        </div>

        <!-- BOT√ìN VOLVER -->
        <div class="text-center mt-3">
          <a href="{% url 'inicio' %}" class="btn-purple w-100">Volver al inicio</a>
        </div>
      </aside>
    </div>
  </div>
</div>

<!-- Modal para el ticket -->
<div id="ticketModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
   
    <div class="receipt-header">
      <h3>COMESTIBLES LA MERCED</h3>
      <p>{{ sucursal.nombresucursal|upper }}</p>
      <p>VENTA #<span id="numeroVenta">0000</span></p>
      <p id="fechaTicket">{{ today|date:"l, F d, Y"|upper }}</p>
    </div>
   
    <div class="receipt-divider"></div>
   
    <div class="receipt-line">
      <span>CANT</span>
      <span>PRODUCTO</span>
      <span>TOTAL</span>
    </div>
   
    <div id="ticketItems">
      <!-- Los productos se insertar√°n aqu√≠ -->
    </div>
   
    <div class="receipt-divider"></div>
   
    <div class="receipt-line">
      <span>SUBTOTAL:</span>
      <span id="subtotalTicket">$0</span>
    </div>
   
    <div class="receipt-line">
      <span>RECARGO:</span>
      <span id="recargoTicket">$0</span>
    </div>
   
    <div class="receipt-line">
      <span>TOTAL:</span>
      <span id="totalTicket">$0</span>
    </div>

    <div class="receipt-line">
      <span>M√âTODO PAGO:</span>
      <span id="metodoPagoTicket">EFECTIVO</span>
    </div>
   
    <div class="receipt-divider"></div>
   
    <p style="text-align: center;">¬°GRACIAS POR SU COMPRA!</p>
    <p style="text-align: center;">Comestibles la Merced</p>
    <div class="ticket-actions" style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
      <button class="btn-green" onclick="confirmarImpresion()">üñ®Ô∏è Imprimir</button>
      <button class="btn-red" onclick="cerrarTicket()">‚ùå Cancelar</button>
    </div>
  </div>
</div>
<!-- Modal de confirmaci√≥n NUEVO -->
<div id="confirmModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <h3>Confirmaci√≥n de venta</h3>
    <p>¬øEst√°s seguro?</p>
    <div class="modal-actions" style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
      <button class="btn-red" onclick="cerrarConfirmacion()">Cancelar</button>
      <button class="btn-green" onclick="procesarVentaDesdeTicket()">Aceptar</button>
    </div>
  </div>
</div>

<!-- Cargar JavaScript -->
<script>
  // Pasar datos de Django a JavaScript
  const productosData = {{ productos_json|safe }};
  const csrfToken = '{{ csrf_token }}';
  const procesarVentaUrl = '{% url "ventas:procesar_venta" %}';
</script>

<script src="{% static 'JS/ticket.js' %}"></script>
<script src="{% static 'JS/ventas.js' %}"></script>

</body>
</html>
