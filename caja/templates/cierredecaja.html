{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="{% static 'CSS/stylecajaApertura.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>Cierre de Caja</title>
</head>
<body>
  <div class="MargenesCaja">
    <div class="EncabezadoCajaApertura">
      <div class="TituloEncabezadoCajaAper">
        <h2>🛒 SuperMercado La Merced</h2>
        <p class="SubtituloSuper">Cierre de Caja</p>
      </div>
      <div class="EncabezadoInfoUsu">
        <div class="UsuarioInfo">
          <span class="IconoUsu">👤</span>
          <span id="nombreusuario">Cajero: {{ usuario_nombre }}</span>
        </div>
        <div class="UsuarioFecha">
          <span id="fecha-actual">{{ fecha_actual }}</span>
        </div>
      </div>
    </div>

    <div class="EstadoCaja" id="EstadoCaja">
      <div class="EstadoCajaEncabezado">
        <h2>ESTADO DE CAJA</h2>
        <div class="EstadoIndicador abierta" id="EstadoIndicador">
          <span class="EstadoCirculo"></span>
          <span class="EstadoTexto">ABIERTA</span>
        </div>
      </div>
      <div class="EstadoDetalles">
        {% if caja %}
        <p id="EstadoMensaje">
          Caja abierta: {{ caja.nombrecaja }}<br>
          Monto inicial: ${{ caja.montoinicialcaja|floatformat:2 }}<br>
          Apertura: {{ caja.fechaaperturacaja|date:"d/m/Y" }} - {{ caja.horaaperturacaja|time:"H:i" }}
        </p>
        {% else %}
        <p id="EstadoMensaje">No hay información de caja disponible</p>
        {% endif %}
      </div>
    </div>

    <div class="AperturaPanel" id="AperturaPanelID">
      <div class="PanelAperEncabezado">
        <h2>🔒 Cierre de Caja</h2>
      </div>
    </div>
    <!-- RESUMEN DE VENTAS - AGREGAR ESTO -->
    <div class="resumen-ventas">
        <h3>📊 Resumen de Ventas del Día</h3>
        <div class="ventas-grid">
            <div class="venta-item">
                <span class="venta-label">Ventas en Efectivo:</span>
                <span class="venta-monto">${{ ventas_efectivo|floatformat:2 }}</span>
            </div>
            <div class="venta-item">
                <span class="venta-label">Ventas con Tarjeta:</span>
                <span class="venta-monto">${{ ventas_tarjeta|floatformat:2 }}</span>
            </div>
            <div class="venta-item">
                <span class="venta-label">Ventas por Transferencia:</span>
                <span class="venta-monto">${{ ventas_transferencia|floatformat:2 }}</span>
            </div>
            <div class="venta-item total">
                <span class="venta-label">Total Ventas Sistema:</span>
                <span class="venta-monto">${{ total_sistema|floatformat:2 }}</span>
            </div>
        </div>
    </div>
    <!-- FORM -->
    <form method="post">
      {% csrf_token %}
      <div class="AperturaPanelCuerpo">
        {% if caja %}
        <!-- EFECTIVO ESPERADO - NUEVO CAMPO -->
        <div class="FormularioMontoIni">
          <label>💰 Efectivo Esperado en Caja</label>
          <div class="monto-esperado">
            <span class="divisa">$</span>
            <input type="text" class="form-control" readonly 
                  value="{{ total_efectivo_esperado|floatformat:2 }}">
            
          </div>
          <small class="text-muted">Fondo inicial (${{ caja.montoinicialcaja|floatformat:2 }}) + Ventas efectivo</small>
        </div>

        <!-- CAMPO ORIGINAL MODIFICADO -->
        <div class="FormularioMontoIni">
          <label>💵 Efectivo Físico Contado</label>
          <div class="FormularioInputMontoIni">
            <span class="divisa">$</span>
            <input type="number" name="monto_final_efectivo" class="form-control" 
                  step="0.01" min="0" required value="{{ caja.montofinalcaja }}" placeholder="0.00">
          </div>
          <small class="text-muted">Ingrese el monto real contado en efectivo</small>
        </div>

        <div class="FormularioMontoIni">
          <label>📝 Observaciones de cierre:</label>
          <textarea name="observacion_cierre" class="form-control" rows="3" 
                    placeholder="Notas sobre diferencias, incidencias..."></textarea>
        </div>

        <!-- BOTONES - AGREGAR CANCELAR -->
        <div class="boton1" style="display: flex; gap: 10px;">
          <a href="{% url 'inicio' %}" class="boton boton-secundario"> Cancelar</a>
          <button type="submit" id="boton-cierre" class="boton boton-primario"> Cerrar Caja</button>
        </div>
        {% else %}
        <div class="alert alert-warning">
          No hay una caja abierta para cerrar.
        </div>
        <div class="boton1">
          <a href="{% url 'inicio' %}" class="boton boton-primario">← Volver al Inicio</a>
        </div>
        {% endif %}
      </div>
    </form>

    <div class="abajo"></div>

    {% if messages %}
      <div id="notification" class="alert alert-info" style="display:none;">
        {% for message in messages %}
          {{ message }}
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <script src="{% static 'JS/apertura_caja.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>