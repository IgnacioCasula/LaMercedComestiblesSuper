{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="{% static 'CSS/stylecajaApertura.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>Cierre de Caja</title>
</head>
<body>
  <div class="MargenesCaja">
    <div class="EncabezadoCajaApertura">
      <div class="TituloEncabezadoCajaAper">
        <h2>üõí SuperMercado La Merced</h2>
        <p class="SubtituloSuper">Cierre de Caja</p>
      </div>
      <div class="EncabezadoInfoUsu">
        <div class="UsuarioInfo">
          <span class="IconoUsu">üë§</span>
          <span id="nombreusuario">Cajero: {{ usuario_nombre }}</span>
        </div>
        <div class="UsuarioFecha">
          <span id="fecha-actual">{{ fecha_actual }}</span>
        </div>
      </div>
    </div>

    <div class="EstadoCaja" id="EstadoCaja">
      <div class="EstadoCajaEncabezado">
        <h2>ESTADO DE CAJA</h2>
        <div class="EstadoIndicador abierta" id="EstadoIndicador">
          <span class="EstadoCirculo"></span>
          <span class="EstadoTexto">ABIERTA</span>
        </div>
      </div>
      <div class="EstadoDetalles">
        {% if caja %}
        <p id="EstadoMensaje">
          Caja abierta: {{ caja.nombrecaja }}<br>
          Monto inicial: ${{ caja.montoinicialcaja|floatformat:2 }}<br>
          Apertura: {{ caja.fechaaperturacaja|date:"d/m/Y" }} - {{ caja.horaaperturacaja|time:"H:i" }}
        </p>
        {% else %}
        <p id="EstadoMensaje">No hay informaci√≥n de caja disponible</p>
        {% endif %}
      </div>
    </div>

    <div class="AperturaPanel" id="AperturaPanelID">
      <div class="PanelAperEncabezado">
        <h2>üîí Cierre de Caja</h2>
      </div>
    </div>
    <!-- RESUMEN DE VENTAS - AGREGAR ESTO -->
    <!-- RESUMEN DE VENTAS - ACTUALIZADO -->
    <!-- RESUMEN DE VENTAS - MEJORADO -->
    <div class="info-calculos">
        <h3>üìä Resumen para Cierre de Caja</h3>
        <div class="calculos-grid">
            <div class="calculo-item">
                <span class="calculo-label">Monto Inicial:</span>
                <span class="calculo-valor">${{ caja.montoinicialcaja|floatformat:2 }}</span>
            </div>
            
            <div class="calculo-item">
                <span class="calculo-label">+ Ventas Efectivo:</span>
                <span class="calculo-valor">${{ ventas_efectivo|floatformat:2 }}</span>
            </div>
            
            <div class="calculo-item">
                <span class="calculo-label">+ Ventas Tarjeta:</span>
                <span class="calculo-valor">${{ ventas_tarjeta|floatformat:2 }}</span>
            </div>
            
            <div class="calculo-item">
                <span class="calculo-label">+ Ventas Transferencia:</span>
                <span class="calculo-valor">${{ ventas_transferencia|floatformat:2 }}</span>
            </div>
            
            <div class="calculo-item total">
                <span class="calculo-label">Total Ventas Sistema:</span>
                <span class="calculo-valor">${{ total_sistema|floatformat:2 }}</span>
            </div>
            
            <!-- Mostrar ambos saldos claramente -->
            <div class="calculo-item importante">
                <span class="calculo-label">üí≥ Saldo Total del Sistema:</span>
                <span class="calculo-valor">${{ saldo_actual_sistema|floatformat:2 }}</span>
                <small class="text-muted">(Incluye todos los m√©todos de pago)</small>
            </div>
            
            <div class="calculo-item importante">
                <span class="calculo-label">üí∞ Efectivo en Sistema:</span>
                <span class="calculo-valor">${{ efectivo_actual_sistema|floatformat:2 }}</span>
                <small class="text-muted">(Solo transacciones en efectivo)</small>
            </div>
        </div>
    </div>


    <!-- ‚úÖ NUEVO: MOVIMIENTOS DE CAJA -->
    <!-- ‚úÖ MOVIMIENTOS DE CAJA -->
    <div class="movimientos-caja">
        <h3>üìã Movimientos de Caja del D√≠a</h3>
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Hora</th>
                        <th>Tipo</th>
                        <th>Concepto</th>
                        <th>Valor</th>
                        <th>Saldo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mov in movimientos_caja %}
                    <tr>
                        <td>{{ mov.horamovcaja|time:"H:i" }}</td>
                        <td>
                            <span class="badge 
                                {% if mov.tipomovcaja == 'APERTURA' %}bg-primary
                                {% elif mov.tipomovcaja == 'INGRESO' %}bg-success
                                {% elif mov.tipomovcaja == 'EGRESO' %}bg-danger
                                {% elif mov.tipomovcaja == 'CIERRE' %}bg-warning
                                {% else %}bg-secondary{% endif %}">
                                {{ mov.tipomovcaja }}
                            </span>
                        </td>
                        <td>{{ mov.conceptomovcaja }}</td>
                        <td>
                            {% if mov.tipomovcaja == 'INGRESO' %}
                            <span class="text-success">+${{ mov.valormovcaja|floatformat:2 }}</span>
                            {% elif mov.tipomovcaja == 'EGRESO' %}
                            <span class="text-danger">-${{ mov.valormovcaja|floatformat:2 }}</span>
                            {% else %}
                            ${{ mov.valormovcaja|floatformat:2 }}
                            {% endif %}
                        </td>
                        <td><strong>${{ mov.saldomovcaja|floatformat:2 }}</strong></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-inbox"></i>
                            No hay movimientos registrados hoy
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if movimientos_caja %}
                <tfoot>
                    <tr class="table-active">
                        <td colspan="3"><strong>Total Final:</strong></td>
                        <td colspan="2">
                            <strong>${{ total_efectivo_esperado|floatformat:2 }}</strong>
                        </td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>


    <!-- FORM -->
    <form method="post">
      {% csrf_token %}
      <div class="AperturaPanelCuerpo">
        {% if caja %}
        <!-- MOSTRAR AMBOS SALDOS EN EL FORMULARIO -->
        <div class="FormularioMontoIni">
          <label>üí≥ Saldo Total del Sistema</label>
          <div class="monto-esperado">
            <span class="divisa">$</span>
            <input type="text" class="form-control" readonly 
                  value="{{ saldo_actual_sistema|floatformat:2 }}">
          </div>
          <small class="text-muted">Total registrado en el sistema (todos los m√©todos de pago)</small>
        </div>

        <div class="FormularioMontoIni">
          <label>üí∞ Efectivo en Sistema</label>
          <div class="monto-esperado">
            <span class="divisa">$</span>
            <input type="text" class="form-control" readonly 
                  value="{{ efectivo_actual_sistema|floatformat:2 }}">
          </div>
          <small class="text-muted">Solo transacciones en efectivo registradas</small>
        </div>

        <!-- CAMPO ORIGINAL MODIFICADO -->
        <div class="FormularioMontoIni">
          <label>üíµ Efectivo F√≠sico Contado (Real)</label>
          <div class="FormularioInputMontoIni">
            <span class="divisa">$</span>
            <input type="number" name="monto_final_efectivo" class="form-control" 
                  step="0.01" min="0" required value="{{ efectivo_actual_sistema|floatformat:2 }}" placeholder="0.00">
          </div>
          <small class="text-muted">Ingrese el monto real contado en efectivo para comparar con el efectivo en sistema</small>
        </div>

        <div class="FormularioMontoIni">
          <label>üìù Observaciones de cierre:</label>
          <textarea name="observacion_cierre" class="form-control" rows="3" 
                    placeholder="Notas sobre diferencias, incidencias..."></textarea>
        </div>

        <!-- BOTONES -->
        <div class="boton1" style="display: flex; gap: 10px;">
          <a href="{% url 'inicio' %}" class="boton boton-secundario"> Cancelar</a>
          <button type="button" id="boton-cierre" class="boton boton-primario" onclick="mostrarModalCierre()"> Cerrar Caja</button>
        </div>
        {% else %}
        <div class="alert alert-warning">
          No hay una caja abierta para cerrar.
        </div>
        <div class="boton1">
          <a href="{% url 'inicio' %}" class="boton boton-primario">‚Üê Volver al Inicio</a>
        </div>
        {% endif %}
      </div>
    </form>

    <div class="abajo"></div>

    {% if messages %}
      <div id="notification" class="alert alert-info" style="display:none;">
        {% for message in messages %}
          {{ message }}
        {% endfor %}
      </div>
    {% endif %}


    <!-- Modal de confirmaci√≥n de cierre -->
    <div id="modalCierreCaja" class="modal-overlay" style="display: none;">
        <div class="modalcierre">
            <div class="modal-header">
                <h3>üîí Confirmar Cierre de Caja</h3>
                <button type="button" class="btn-cerrar" onclick="cerrarModalCierre()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="resumen-cierre">
                    <h4>üìä Resumen de Cierre</h4>
                    <div class="resumen-item">
                        <span>Ventas en Efectivo:</span>
                        <span>${{ ventas_efectivo|floatformat:2 }}</span>
                    </div>
                    <div class="resumen-item">
                        <span>Ventas con Tarjeta:</span>
                        <span>${{ ventas_tarjeta|floatformat:2 }}</span>
                    </div>
                    <div class="resumen-item">
                        <span>Ventas por Transferencia:</span>
                        <span>${{ ventas_transferencia|floatformat:2 }}</span>
                    </div>
                    <div class="resumen-item total">
                        <span>Total Ventas Sistema:</span>
                        <span>${{ total_sistema|floatformat:2 }}</span>
                    </div>
                    <div class="resumen-item destacado">
                        <span>Saldo Actual del Sistema:</span>
                        <span>${{ saldo_actual_sistema|floatformat:2 }}</span>
                    </div>
                </div>
                
                <div class="alerta-importante">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>¬øEst√°s seguro de que deseas cerrar la caja?</strong>
                        <p>Esta acci√≥n registrar√° el cierre de tu jornada y no se podr√° revertir.</p>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secundario" onclick="cerrarModalCierre()">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primario" onclick="confirmarCierre()">
                        <i class="fas fa-check"></i>
                        S√≠, Cerrar Caja
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    function mostrarModalCierre() {
        document.getElementById('modalCierreCaja').style.display = 'flex';
    }

    function cerrarModalCierre() {
        document.getElementById('modalCierreCaja').style.display = 'none';
    }

    function confirmarCierre() {
        // Validar que se haya ingresado el monto final
        const montoFinal = document.querySelector('input[name="monto_final_efectivo"]').value;
        if (!montoFinal || parseFloat(montoFinal) < 0) {
            alert('‚ùå Por favor ingrese un monto final v√°lido');
            return;
        }
        
        // Enviar el formulario de cierre
        document.querySelector('form').submit();
    }
    </script>


  </div>

  <script src="{% static 'JS/apertura_caja.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>