{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Movimiento de Caja</title>
    <link rel="stylesheet" href="{% static 'CSS/movimientos_caja.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container-movimientos">
        <!-- Encabezado -->
        <div class="encabezado-movimientos">
            <div class="titulo-encabezado">
                <h2>üõí SuperMercado La Merced</h2>
                <p class="subtitulo">Agregar Movimiento de Caja</p>
            </div>
            <div class="info-usuario">
                <div class="usuario-info">
                    <span class="icono-usuario">üë§</span>
                    <span>Usuario: {{ usuario_nombre }}</span>
                </div>
                <div class="usuario-fecha">
                    <span>{{ fecha_actual }}</span>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n de caja -->
        {% if caja_activa and caja_abierta %}
        <div class="info-caja-activa">
            <div class="caja-info">
                <h3>üì¶ Caja Activa</h3>
                <p><strong>{{ caja_activa.nombrecaja }}</strong></p>
                <p>Monto Inicial: ${{ caja_activa.montoinicialcaja|floatformat:2 }}</p>
                <p class="saldo-actual">Saldo Actual: <strong>${{ saldo_actual|floatformat:2 }}</strong></p>
            </div>
        </div>
        {% else %}
        <div class="alerta-caja cerrada">
            <div class="alerta-content">
                <i class="fas fa-exclamation-triangle"></i>
                <span>No hay caja activa. Debe abrir una caja para realizar movimientos.</span>
            </div>
        </div>
        {% endif %}

        <!-- Formulario -->
        <form method="post" class="formulario-movimiento" id="form-movimiento">
            {% csrf_token %}
            
            <div class="panel-formulario">
                <div class="panel-encabezado">
                    <h2>üìã Datos del Movimiento</h2>
                </div>
                
                <div class="panel-cuerpo">
                    <!-- Campos autom√°ticos -->
                    <div class="campos-automaticos">
                        <div class="campo-grupo">
                            <label>Usuario</label>
                            <input type="text" class="form-control" value="{{ usuario_nombre }}" readonly>
                        </div>
                        
                        <div class="campo-grupo">
                            <label>Caja</label>
                            <input type="text" class="form-control" 
                                   value="{{ caja_activa.nombrecaja|default:'Caja General' }}" readonly>
                        </div>
                        
                        <div class="campo-grupo">
                            <label>Fecha</label>
                            <input type="text" class="form-control" value="{{ fecha_actual }}" readonly>
                        </div>
                        
                        <div class="campo-grupo">
                            <label>Hora</label>
                            <input type="text" class="form-control" value="{{ hora_actual }}" readonly>
                        </div>
                    </div>

                    <!-- Campos a completar -->
                    <div class="campos-completar">
                        <div class="campo-grupo">
                            <label for="tipo">Tipo *</label>
                            <select name="tipo" id="tipo" class="form-control" required {% if not caja_abierta %}disabled{% endif %}>
                                <option value="">Seleccionar Tipo</option>
                                {% for valor, texto in tipos_movimiento %}
                                <option value="{{ valor }}">{{ texto }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="campo-grupo">
                            <label for="concepto">Concepto *</label>
                            <select name="concepto" id="concepto" class="form-control" required {% if not caja_abierta %}disabled{% endif %}>
                                <option value="">Primero seleccione un tipo</option>
                                <!-- Las opciones se cargar√°n din√°micamente -->
                            </select>
                        </div>

                        <div class="campo-grupo">
                            <label for="valor">Valor *</label>
                            <div class="input-con-icono">
                                <span class="icono-moneda">$</span>
                                <input type="number" name="valor" id="valor" class="form-control" 
                                       step="0.01" min="0.01" placeholder="0.00" required 
                                       {% if not caja_abierta %}disabled{% endif %}>
                            </div>
                            {% if caja_abierta %}
                            <small class="text-info" id="info-saldo">
                                Saldo disponible: ${{ saldo_actual|floatformat:2 }}
                            </small>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="botones-accion">
                        <a href="{% url 'caja:movimientos_caja_menu' %}" class="btncancelar btncan">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </a>
                        <button type="submit" class="btnconfirmar btncon" id="btn-submit" {% if not caja_abierta %}disabled{% endif %}>
                            <i class="fas fa-check"></i>
                            Registrar Movimiento
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <!-- Mensajes -->
        {% if messages %}
        <div class="mensajes-container">
            {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Modal de advertencia caja cerrada -->
    <div id="modalCajaCerrada" class="modal-overlay" style="display: none;">
        <div class="modal-content modal-centrado">
            <div class="modal-header">
                <h3>‚ö†Ô∏è Caja Cerrada</h3>
                <button type="button" class="btn-cerrar" onclick="cerrarModalCajaCerrada()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="alerta-importante">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>No puede realizar movimientos</strong>
                        <p>Debe realizar la apertura de caja antes de agregar movimientos.</p>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primario" onclick="irAAperturaCaja()">
                        <i class="fas fa-cash-register"></i>
                        Ir a Apertura de Caja
                    </button>
                    <button type="button" class="btn btn-secundario" onclick="cerrarModalCajaCerrada()">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // SOLUCI√ìN CORREGIDA - JavaScript mejorado para movimientos de caja
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ DOM cargado - Inicializando sistema de movimientos');
            
            // Elementos del DOM
            const tipoSelect = document.getElementById('tipo');
            const conceptoSelect = document.getElementById('concepto');
            const valorInput = document.getElementById('valor');
            const form = document.getElementById('form-movimiento');
            const btnSubmit = document.getElementById('btn-submit');
            
            // Estado de la caja desde Django
            const cajaAbierta = {{ caja_abierta|yesno:"true,false" }};
            const saldoActual = parseFloat({{ saldo_actual|default:0 }});

            // CONCEPTOS POR TIPO - DEFINIDOS DIRECTAMENTE EN EL SCRIPT
            const conceptosPorTipo = {
                'INGRESO': [
                    'Venta de Producto',
                    'Ajuste de caja', 
                    'Transf. a Caja',
                    'Otros ingresos'
                ],
                'EGRESO': [
                    'Pago de sueldos',
                    'Pago a Proveedor',
                    'Pago de servicios',
                    'Gastos varios',
                    'Transf. desde Caja',
                    'Otros egresos'
                ]
            };

            console.log('Conceptos cargados:', conceptosPorTipo);

            // FUNCI√ìN PARA ACTUALIZAR CONCEPTOS
            function actualizarConceptos() {
                const tipoSeleccionado = tipoSelect.value;
                console.log('üîπ Tipo seleccionado:', tipoSeleccionado);
                
                // Limpiar select de conceptos
                conceptoSelect.innerHTML = '<option value="">Seleccionar Concepto</option>';
                
                // Si hay un tipo seleccionado v√°lido, cargar sus conceptos
                if (tipoSeleccionado && conceptosPorTipo[tipoSeleccionado]) {
                    conceptosPorTipo[tipoSeleccionado].forEach(concepto => {
                        const option = document.createElement('option');
                        option.value = concepto;
                        option.textContent = concepto;
                        conceptoSelect.appendChild(option);
                    });
                    console.log('‚úÖ Conceptos cargados para', tipoSeleccionado, ':', conceptosPorTipo[tipoSeleccionado]);
                } else {
                    console.log('‚ùå No hay conceptos para el tipo:', tipoSeleccionado);
                }
                
                // Validar formulario despu√©s de actualizar conceptos
                validarFormulario();
            }

            // FUNCI√ìN PARA VALIDAR VALOR
            function validarValor() {
                const tipo = tipoSelect.value;
                const valor = parseFloat(valorInput.value) || 0;
                const infoSaldo = document.getElementById('info-saldo');
                
                if (!infoSaldo) return true;
                
                if (tipo === 'EGRESO' && valor > saldoActual) {
                    valorInput.classList.add('is-invalid');
                    infoSaldo.innerHTML = `‚ùå Saldo insuficiente. Disponible: $${saldoActual.toFixed(2)}`;
                    infoSaldo.classList.remove('text-info');
                    infoSaldo.classList.add('text-danger');
                    return false;
                } else {
                    valorInput.classList.remove('is-invalid');
                    infoSaldo.innerHTML = `Saldo disponible: $${saldoActual.toFixed(2)}`;
                    infoSaldo.classList.remove('text-danger');
                    infoSaldo.classList.add('text-info');
                    return true;
                }
            }

            // FUNCI√ìN PARA VALIDAR FORMULARIO COMPLETO
            function validarFormulario() {
                const tipo = tipoSelect.value;
                const concepto = conceptoSelect.value;
                const valor = parseFloat(valorInput.value) || 0;
                
                let valido = true;
                
                if (!tipo || !concepto || valor <= 0) {
                    valido = false;
                }
                
                if (tipo === 'EGRESO' && valor > saldoActual) {
                    valido = false;
                }
                
                // Actualizar estado del bot√≥n
                if (btnSubmit) {
                    btnSubmit.disabled = !valido;
                }
                
                return valido;
            }

            // INICIALIZACI√ìN DE EVENT LISTENERS
            function inicializarEventListeners() {
                console.log('üîß Inicializando event listeners...');
                
                // Event listener para cambio de tipo
                if (tipoSelect) {
                    tipoSelect.addEventListener('change', function() {
                        console.log('üîÑ Cambio detectado en tipo:', this.value);
                        actualizarConceptos();
                        validarValor();
                    });
                }
                
                // Event listener para cambio de valor
                if (valorInput) {
                    valorInput.addEventListener('input', function() {
                        validarValor();
                        validarFormulario();
                    });
                }
                
                // Event listener para cambio de concepto
                if (conceptoSelect) {
                    conceptoSelect.addEventListener('change', function() {
                        validarFormulario();
                    });
                }
                
                // Validaci√≥n antes de enviar formulario
                if (form) {
                    form.addEventListener('submit', function(e) {
                        console.log('üì§ Intentando enviar formulario...');
                        
                        if (!cajaAbierta) {
                            e.preventDefault();
                            mostrarModalCajaCerrada();
                            console.log('‚ùå Caja cerrada - bloqueando env√≠o');
                            return false;
                        }

                        const tipo = tipoSelect.value;
                        const concepto = conceptoSelect.value;
                        const valor = parseFloat(valorInput.value) || 0;

                        // Validaciones finales
                        if (!tipo || !concepto) {
                            e.preventDefault();
                            alert('‚ùå Por favor complete todos los campos obligatorios');
                            console.log('‚ùå Campos incompletos');
                            return false;
                        }

                        if (valor <= 0) {
                            e.preventDefault();
                            alert('‚ùå El valor debe ser mayor a 0');
                            valorInput.focus();
                            console.log('‚ùå Valor inv√°lido');
                            return false;
                        }

                        if (tipo === 'EGRESO' && valor > saldoActual) {
                            e.preventDefault();
                            alert(`‚ùå No hay suficiente saldo. Saldo actual: $${saldoActual.toFixed(2)}`);
                            valorInput.focus();
                            console.log('‚ùå Saldo insuficiente');
                            return false;
                        }

                        // Mostrar loading
                        if (btnSubmit) {
                            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                            btnSubmit.disabled = true;
                        }
                        
                        console.log('‚úÖ Formulario v√°lido - enviando...');
                    });
                }
                
                console.log('‚úÖ Event listeners configurados correctamente');
            }

            // INICIALIZAR TODO
            function inicializarSistema() {
                console.log('üöÄ Inicializando sistema de movimientos...');
                console.log('Estado caja:', cajaAbierta ? 'Abierta' : 'Cerrada');
                console.log('Saldo actual:', saldoActual);
                
                // Inicializar event listeners
                inicializarEventListeners();
                
                // Si la caja est√° cerrada, deshabilitar todo
                if (!cajaAbierta) {
                    console.log('‚ö†Ô∏è Caja cerrada - deshabilitando controles');
                    if (tipoSelect) tipoSelect.disabled = true;
                    if (conceptoSelect) conceptoSelect.disabled = true;
                    if (valorInput) valorInput.disabled = true;
                    if (btnSubmit) btnSubmit.disabled = true;
                } else {
                    console.log('‚úÖ Caja abierta - controles habilitados');
                    // Forzar actualizaci√≥n inicial de conceptos
                    actualizarConceptos();
                }
                
                console.log('‚úÖ Sistema de movimientos inicializado correctamente');
            }

            // EJECUTAR INICIALIZACI√ìN
            inicializarSistema();
        });

        // FUNCIONES DEL MODAL (mantener como globales)
        function mostrarModalCajaCerrada() {
            const modal = document.getElementById('modalCajaCerrada');
            if (modal) {
                modal.style.display = 'flex';
                console.log('üì± Mostrando modal de caja cerrada');
            }
        }

        function cerrarModalCajaCerrada() {
            const modal = document.getElementById('modalCajaCerrada');
            if (modal) {
                modal.style.display = 'none';
                console.log('‚ùå Cerrando modal de caja cerrada');
            }
        }

        function irAAperturaCaja() {
            console.log('‚û°Ô∏è Redirigiendo a apertura de caja');
            window.location.href = "{% url 'caja:apertura_caja' %}";
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>